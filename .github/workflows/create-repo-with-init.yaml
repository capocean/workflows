name: Create Repository with Init Workflow

on:
  workflow_dispatch:
    inputs:
      repository_name:
        description: 'Repository Name'
        required: true
        type: string
      description:
        description: 'Repository Description'
        required: false
        type: string
        default: ''
      visibility:
        description: 'Repository Visibility'
        required: true
        type: string
        default: 'private'
      auto_init:
        description: 'Initialize with README'
        required: false
        type: string
        default: 'true'
      run_id:
        description: 'Port Run ID'
        required: true
        type: string

jobs:
  create-repository:
    runs-on: ubuntu-latest
    steps:
      - name: Inform Port of workflow start
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.run_id }}
          logMessage: |
            Creating GitHub repository: ${{ inputs.repository_name }} ... ⚙️

      - name: Create GitHub Repository
        id: create_repo
        run: |
          # Convert auto_init string to boolean
          AUTO_INIT="false"
          if [ "${{ inputs.auto_init }}" = "true" ]; then
            AUTO_INIT="true"
          fi
          
          # Convert visibility to private boolean
          PRIVATE="true"
          if [ "${{ inputs.visibility }}" = "public" ]; then
            PRIVATE="false"
          fi
          
          # Set description (handle empty string)
          DESCRIPTION="${{ inputs.description }}"
          if [ -z "$DESCRIPTION" ]; then
            DESCRIPTION="Repository created via Port"
          fi
          
          echo "Creating repository with settings:"
          echo "  Name: ${{ inputs.repository_name }}"
          echo "  Description: $DESCRIPTION"
          echo "  Private: $PRIVATE"
          echo "  Auto Init: $AUTO_INIT"
          
          RESPONSE=$(curl -s -w "%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/user/repos \
            -d "{
              \"name\": \"${{ inputs.repository_name }}\",
              \"description\": \"$DESCRIPTION\",
              \"private\": $PRIVATE,
              \"auto_init\": $AUTO_INIT
            }")
          
          # Split response and status code
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            REPO_URL=$(echo "$BODY" | jq -r '.html_url')
            REPO_FULL_NAME=$(echo "$BODY" | jq -r '.full_name')
          
            # Use delimiter for multiline output
            echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
            echo "repo_full_name=$REPO_FULL_NAME" >> $GITHUB_OUTPUT
          
            echo "Repository created: $REPO_URL"
          else
            echo "Failed to create repository (HTTP $HTTP_CODE)"
            echo "$BODY" | jq .
            exit 1
          fi

      - name: Inform Port of repository creation
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.run_id }}
          logMessage: |
            Repository created: ${{ steps.create_repo.outputs.repo_url }}
            Adding init.yml workflow file...

      - name: Wait for repository initialization
        run: sleep 5

      - name: Checkout central workflows repository
        uses: actions/checkout@v4
        with:
          repository: bdocean/workflows
          token: ${{ secrets.GH_PAT }}
          path: central-repo

      - name: Get init.yml content
        id: get_init_yml
        run: |
          if [ ! -f "central-repo/.github/workflows/init.yml" ]; then
            echo "init.yml not found in central repository at .github/workflows/init.yml"
            exit 1
          fi
          
          INIT_YML_CONTENT=$(cat central-repo/.github/workflows/init.yml | base64 -w 0)
          
          # Use delimiter for multiline output
          {
            echo "content<<EOF"
            echo "$INIT_YML_CONTENT"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "init.yml content retrieved from bdocean/workflows"

      - name: Create init.yml in new repository
        id: create_init_file
        run: |
          echo "Creating init.yml in ${{ steps.create_repo.outputs.repo_full_name }}"
          
          RESPONSE=$(curl -s -w "%{http_code}" -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ steps.create_repo.outputs.repo_full_name }}/contents/.github/workflows/init.yml" \
            -d "{
              \"message\": \"Add init workflow from central repository\",
              \"content\": \"${{ steps.get_init_yml.outputs.content }}\"
            }")
          
          # Split response and status code
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            FILE_URL=$(echo "$BODY" | jq -r '.content.html_url')
            echo "file_url=$FILE_URL" >> $GITHUB_OUTPUT
            echo "init.yml workflow file added to new repository"
            echo "   File URL: $FILE_URL"
          else
            echo "Warning: Could not create init.yml file (HTTP $HTTP_CODE)"
            echo "$BODY" | jq . || echo "$BODY"
            # Don't fail the entire workflow, just warn
          fi

      - name: Inform Port of completion
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.run_id }}
          logMessage: |
            Repository created successfully: ${{ steps.create_repo.outputs.repo_url }}
            init.yml workflow file added from bdocean/workflows

      - name: Inform Port of action status
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          status: "SUCCESS"
          runId: ${{ inputs.run_id }}
          link: ${{ steps.create_repo.outputs.repo_url }}

      - name: Inform Port of failure
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          status: "FAILURE"
          runId: ${{ inputs.run_id }}
          logMessage: |
            Failed to create repository or add init.yml workflow file
