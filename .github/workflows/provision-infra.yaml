name: Provision Infrastructure

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: Repository name
        required: true
      repo_description:
        description: Repository description
        required: true
      jira_issue_key:
        description: Jira issue key
        required: true
      environment:
        description: Environment (dev/staging/prod)
        required: false
        default: dev
      port_context:
        description: Port context
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  provision-resources:
    runs-on: ubuntu-latest
    outputs:
      repo_url: ${{ steps.create-repo.outputs.repo_url }}
      stack_name: ${{ steps.deploy-stack.outputs.stack_name }}
      bucket_name: ${{ steps.get-outputs.outputs.bucket_name }}
      bucket_arn: ${{ steps.get-outputs.outputs.bucket_arn }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create GitHub Repository
        id: create-repo
        env:
          GH_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
        run: |
          echo "Creating GitHub repository..."
          
          RESPONSE=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /orgs/capocean/repos \
            -f name='${{ inputs.repo_name }}' \
            -f description='${{ inputs.repo_description }}' \
            -F private=false \
            -F auto_init=true)
          
          REPO_URL=$(echo "$RESPONSE" | jq -r '.html_url')
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "Repository created: $REPO_URL"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::158670531871:role/GitHubActionPort
          aws-region: us-east-2

      - name: Prepare Stack Name
        id: prepare
        run: |
          STACK_NAME="${{ inputs.repo_name }}-${{ inputs.environment }}-stack"
          STACK_NAME=$(echo "$STACK_NAME" | tr '[:upper:]' '[:lower:]')
          echo "stack_name=$STACK_NAME" >> $GITHUB_OUTPUT
          echo "Stack name: $STACK_NAME"

      - name: Deploy CloudFormation Stack
        id: deploy-stack
        run: |
          STACK_NAME="${{ steps.prepare.outputs.stack_name }}"
          
          echo "Deploying CloudFormation stack: $STACK_NAME"
          
          aws cloudformation deploy \
            --template-file cloudformation/s3-infrastructure.yaml \
            --stack-name "$STACK_NAME" \
            --parameter-overrides \
              ProjectName="${{ inputs.repo_name }}" \
              Environment="${{ inputs.environment }}" \
              JiraIssueKey="${{ inputs.jira_issue_key }}" \
            --tags \
              JiraIssue="${{ inputs.jira_issue_key }}" \
              ManagedBy=Port \
              Environment="${{ inputs.environment }}" \
              Repository="${{ inputs.repo_name }}" \
            --no-fail-on-empty-changeset
          
          echo "stack_name=$STACK_NAME" >> $GITHUB_OUTPUT
          echo "CloudFormation stack deployed successfully"

      - name: Get Stack Outputs
        id: get-outputs
        run: |
          STACK_NAME="${{ steps.prepare.outputs.stack_name }}"
          
          echo "Fetching stack outputs from: $STACK_NAME"
          
          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query 'Stacks[0].Outputs' \
            --output json)
          
          BUCKET_NAME=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="BucketName") | .OutputValue')
          BUCKET_ARN=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="BucketArn") | .OutputValue')
          BUCKET_REGION=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="BucketRegion") | .OutputValue')
          
          echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "bucket_arn=$BUCKET_ARN" >> $GITHUB_OUTPUT
          echo "bucket_region=$BUCKET_REGION" >> $GITHUB_OUTPUT
          
          echo "Stack outputs retrieved:"
          echo "  - Bucket Name: $BUCKET_NAME"
          echo "  - Bucket ARN: $BUCKET_ARN"
          echo "  - Bucket Region: $BUCKET_REGION"

      - name: Report Success to Port
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          logMessage: |
            Infrastructure provisioned successfully
            
            Resources Created:
            - Repository: ${{ steps.create-repo.outputs.repo_url }}
            - CloudFormation Stack: ${{ steps.deploy-stack.outputs.stack_name }}
            - S3 Bucket: ${{ steps.get-outputs.outputs.bucket_name }}
            - Bucket ARN: ${{ steps.get-outputs.outputs.bucket_arn }}
            - Region: ${{ steps.get-outputs.outputs.bucket_region }}

      - name: Report Failure to Port
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(inputs.port_context).runId }}
          logMessage: |
            Infrastructure provisioning failed            
            Please check the GitHub Actions logs for details
